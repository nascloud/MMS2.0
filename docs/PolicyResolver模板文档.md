# PolicyResolver 模板文档

## 功能介绍

PolicyResolver（策略解析器）是 Mihomo-Mosdns 同步系统中的核心决策模块，负责解析 Mihomo 中复杂的策略链，找出任意规则的最终出口节点，并将其标准化为 DIRECT、PROXY 或 REJECT。该模块通过递归追踪和备忘录模式实现高性能策略解析，并内置循环依赖检测机制。

## 工作流程

1. **缓存检查**：首先检查请求的策略是否已在缓存中，如果存在则直接返回缓存结果。

2. **策略组类型识别**：从代理数据中动态识别策略组类型，避免硬编码特定类型。

3. **递归解析**：
   - 检查循环依赖：如果当前策略已在解析路径中，则检测到循环依赖，记录错误并返回默认策略
   - 获取策略数据：从代理数据中获取策略信息
   - 判断是否为最终节点：检查策略是否为策略组类型
   - 如果是最终节点，返回策略名称
   - 如果是策略组，获取当前选择（now字段）并递归解析

4. **结果标准化**：将解析得到的最终节点名称标准化为 DIRECT、PROXY 或 REJECT：
   - 检查是否为预定义的标准结果
   - 根据节点类型判断（REJECT 类型、DIRECT 类型、代理类型等）
   - 默认返回 DIRECT

5. **缓存结果**：将解析结果存入缓存以提高后续请求的性能。

## 输入参数

### resolve 方法

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| policy_name | str | 是 | 要解析的策略名称 |
| proxies_data | Dict[str, Any] | 是 | 包含所有代理/策略组数据的 API 响应 |

### _resolve_recursive 方法

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| policy_name | str | 是 | 要解析的策略名称 |
| visited | Set[str] | 是 | 当前解析路径中的策略名称集合，用于循环依赖检测 |
| proxies_data | Dict[str, Any] | 是 | 包含所有代理/策略组数据的 API 响应 |

### _standardize_result 方法

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| result | str | 是 | 解析得到的原始结果 |
| original_policy | str | 是 | 原始策略名称 |
| proxies_data | Dict[str, Any] | 是 | 包含所有代理/策略组数据的 API 响应 |

## 输出参数

### resolve 方法

| 返回类型 | 描述 |
|----------|------|
| str | 标准化的策略结果，可能值为 "DIRECT"、"PROXY" 或 "REJECT" |

### _identify_strategy_group_types 方法

该方法没有返回值，但会产生以下副作用：

1. **策略组类型识别**：更新内部的策略组类型集合，用于后续的策略类型判断。

### _standardize_result 方法

| 返回类型 | 描述 |
|----------|------|
| str | 标准化的策略结果，可能值为 "DIRECT"、"PROXY" 或 "REJECT" |