# RuleDownloader 模板文档

## 功能介绍

RuleDownloader（规则下载器）是 Mihomo-Mosdns 同步系统中的一个辅助模块，负责并发下载并缓存规则文件。该模块通过 HTTP 请求获取远程规则集文件，并将其缓存到本地目录中，以提高后续访问的性能并减少网络请求。

RuleDownloader 使用 httpx 库进行异步 HTTP 请求，并支持并发下载多个规则文件。每个下载的文件都会根据其 URL 生成唯一的缓存键，确保缓存文件的唯一性和可追溯性。

## 工作流程

1. **初始化**：
   - 接收缓存目录路径作为参数
   - 创建缓存目录（如果不存在）
   - 初始化 httpx 客户端会话
   - 设置日志记录器

2. **缓存键生成**：
   - 对每个 URL 使用 SHA256 哈希算法生成唯一的缓存键
   - 确保不同 URL 对应不同的缓存文件

3. **单文件下载**：
   - 发起 HTTP GET 请求获取规则文件内容
   - 检查 HTTP 响应状态码，确保请求成功
   - 将响应内容写入对应的缓存文件

4. **并发下载**：
   - 接收待下载的 URL 列表
   - 为每个 URL 创建下载任务
   - 使用 asyncio.gather 并发执行所有下载任务
   - 等待所有任务完成并处理结果

5. **错误处理**：
   - 网络错误：记录错误日志并继续处理其他文件
   - IO 错误：记录错误日志并继续处理其他文件
   - 其他异常：记录错误日志并继续处理其他文件

## 输入参数

### __init__ 方法

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| client | httpx.AsyncClient | 是 | httpx 异步客户端实例 |
| cache_dir | str | 是 | 缓存目录路径，可通过 config.yaml 中的 cache_dir_path 配置项设置 |
| max_retries | int | 否 | 最大重试次数，默认为 5 |
| initial_backoff | float | 否 | 初始退避时间（秒），默认为 1.0 |
| max_backoff | float | 否 | 最大退避时间（秒），默认为 16.0 |
| jitter | bool | 否 | 是否添加抖动以减少重试冲突，默认为 True |

### get_cache_path_for_url 方法

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| url | str | 是 | 规则文件的 URL |

### _download_with_retry 方法

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| url | str | 是 | 要下载的规则文件 URL |
| headers | dict | 是 | HTTP 请求头 |

### _ensure_rule_updated 方法

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| url | str | 是 | 要确保更新的规则文件 URL |

### download_rules 方法

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| urls | list[str] | 是 | 待下载的 URL 列表 |

## 输出参数

### get_cache_path_for_url 方法

| 返回类型 | 描述 |
|----------|------|
| str | URL 对应的本地缓存文件路径 |

### download_rules 方法

该方法没有返回值，但会产生以下副作用：

1. **文件下载**：将远程规则文件下载到本地缓存目录
2. **缓存文件生成**：在缓存目录中创建以 SHA256 哈希值命名的缓存文件
3. **日志记录**：记录下载过程中的关键信息和错误